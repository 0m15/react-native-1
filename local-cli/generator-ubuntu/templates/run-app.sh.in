#!/bin/bash

# Copyright (C) 2016, Canonical Ltd.
# All rights reserved.

# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree. An additional grant
# of patent rights can be found in the PATENTS file in the same directory.

args=""
on_device=0
plugins_path=""
asset_path="share"

for arg in "$@"
do
  IFS="=" read -a parts <<< "$arg"
  if [ $parts == "--on-device" ]; then
    on_device=1
  elif [ $parts == "--plugins-path" ]; then
    plugins_path=${parts[1]}
    args=$args" --plugins-path=./plugins"
  elif [ $parts == "--asset-path]" ]; then
    asset_path=${parts[1]}
  else
    args=$args" $parts"
  fi
done

(node @CMAKE_SOURCE_DIR@/../node_modules/react-native/ubuntu-server.js 2>&1 > /dev/null) &

if [[ $on_device = 1 ]]
then
  react_host=`hostname -I`
  adb push @CMAKE_BINARY_DIR@/bin/@APP_NAME@ /home/phablet/@APP_NAME@/@APP_NAME@
  [ -d $plugins_path ] && adb push $plugins_path /home/phablet/@APP_NAME@/plugins/
  [ -d $asset_path ] && adb push $asset_path /home/phablet/@APP_NAME@/share/
#  adb reverse --no-rebind tcp:8081 tcp:8081
  adb shell "cd /home/phablet/@APP_NAME@ && REACT_SERVER_HOST=$react_host ./@APP_NAME@ --host $react_host $args -- --desktop_file_hint=/usr/share/applications/webbrowser-app.desktop"
else
  @CMAKE_BINARY_DIR@/bin/@APP_NAME@ $args
fi

